---
title: "P8105 HW2"
author: 'Yutong Mao (UNI: ym3139)'
date: "2025-10-01"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(tidyverse)  
library(janitor)
```


# Problem 1
```{r}
library(tidyverse)

# --- Load data ---
pols  <- readr::read_csv("data/fivethirtyeight_datasets/pols-month.csv")
snp   <- readr::read_csv("data/fivethirtyeight_datasets/snp.csv")
unemp <- readr::read_csv("data/fivethirtyeight_datasets/unemployment.csv")
```

```{r}
pols_clean <- pols |>
  tidyr::separate(
    mon, into = c("year", "month_num", "day"),
    sep = "-", convert = TRUE
  ) |>
  dplyr::mutate(
    month = month.name[month_num],               
    president = dplyr::case_when(               
      prez_gop == 1 ~ "gop",
      prez_dem == 1 ~ "dem",
      TRUE ~ NA_character_
    )
  ) |>
  dplyr::select(                                
    year, month, president,
    gov_gop, sen_gop, rep_gop,
    gov_dem, sen_dem, rep_dem
  ) |>
  dplyr::arrange(year, match(month, month.name))

dplyr::glimpse(pols_clean)

```

```{r}
snp_clean <- snp |>
  dplyr::mutate(
    date = as.Date(date, tryFormats = c("%Y-%m-%d", "%m/%d/%Y"))
  ) |>
  dplyr::transmute(
    year  = as.integer(format(date, "%Y")),
    month_num = as.integer(format(date, "%m")),
    month = month.name[month_num],
    close
  ) |>
  dplyr::arrange(year, month_num) |>
  dplyr::select(-month_num)

dplyr::glimpse(snp_clean)
```

```{r}
unemp_tidy <- unemp |>
  dplyr::rename(year = Year) |>
  tidyr::pivot_longer(
    cols = -year, names_to = "month", values_to = "unemployment_rate"
  ) |>
  dplyr::mutate(
    month = factor(month, levels = month.abb, labels = month.name),
    month = as.character(month)
  ) |>
  dplyr::arrange(year, match(month, month.name))

dplyr::glimpse(unemp_tidy)
```

```{r}
pols_snp <- dplyr::left_join(pols_clean, snp_clean, by = c("year", "month"))
merged   <- dplyr::left_join(pols_snp,  unemp_tidy, by = c("year", "month"))

dplyr::glimpse(merged)
dplyr::count(merged, year, sort = TRUE) |> head(3)

```

### About the datasets and the merged result

The `pols-month` dataset tracks the monthly number of U.S. national politicians by party, together with the president’s affiliation. After cleaning, it contains `r nrow(pols_clean)` rows and `r ncol(pols_clean)` columns. Key variables are `year`, `month`, `president`, and the counts of governors, senators, and representatives from both parties (`gov_*`, `sen_*`, `rep_*`).

The `snp` dataset gives monthly closing values of the S&P index. Once processed, it keeps only `year`, `month`, and `close`, with a total of `r nrow(snp_clean)` observations.

The `unemployment` dataset provides monthly unemployment rates. After being reshaped into a long format, it has `r nrow(unemp_tidy)` rows. The main variables are `year`, `month`, and `unemployment_rate`.

When these three datasets are merged by `year` and `month`, the resulting data frame `merged` includes `r nrow(merged)` rows and `r ncol(merged)` columns. The time span goes from `r min(merged$year, na.rm = TRUE)` to `r max(merged$year, na.rm = TRUE)`. In the final version, the most important variables are the president’s party (`president`), the S&P closing value (`close`), and the unemployment rate (`unemployment_rate`).


# Problem 2

```{r}
library(readxl)
library(dplyr)
library(janitor)

trash_file <- "data/202409 Trash Wheel Collection Data.xlsx"
```


```{r}
read_trashwheel_one <- function(sheet, wheel_label) {
  df <- read_excel(trash_file, sheet = sheet, skip = 1) |>
    clean_names() |>
    filter(!is.na(dumpster))

  if (!"sports_balls" %in% names(df) && "sports" %in% names(df)) df <- rename(df, sports_balls = sports)
  if (!"cigarette" %in% names(df) && "cigarette_butts" %in% names(df)) df <- rename(df, cigarette = cigarette_butts)
  if (!"weight" %in% names(df) && "weight_tons" %in% names(df)) df <- rename(df, weight = weight_tons)
  if (!"volume" %in% names(df) && "volume_cubic_yards" %in% names(df)) df <- rename(df, volume = volume_cubic_yards)
  if (!"plastic" %in% names(df) && "plastic_bottles" %in% names(df)) df <- rename(df, plastic = plastic_bottles)
  if (!"glass" %in% names(df) && "glass_bottles" %in% names(df)) df <- rename(df, glass = glass_bottles)
  if (!"wrapper" %in% names(df) && "wrappers" %in% names(df)) df <- rename(df, wrapper = wrappers)
  if (!"homes" %in% names(df) && "homes_powered" %in% names(df)) df <- rename(df, homes = homes_powered)
  if (!"sports_balls" %in% names(df)) df$sports_balls <- NA_real_

  df |>
    mutate(
      date = suppressWarnings(as.Date(date)),
      year = as.integer(year),
      month = as.character(month),
      sports_balls = as.integer(round(sports_balls)),
      wheel = wheel_label
    ) |>
    select(any_of(c(
      "wheel","dumpster","date","month","year","weight","volume",
      "plastic","polystyrene","cigarette","glass","plastic_bags",
      "wrapper","sports_balls","homes"
    )))
}
```

```{r}
mr   <- read_trashwheel_one("Mr. Trash Wheel", "Mr. Trash Wheel")
prof <- read_trashwheel_one("Professor Trash Wheel", "Professor Trash Wheel")
gwyn <- read_trashwheel_one("Gwynnda Trash Wheel", "Gwynnda Trash Wheel")

trash_all <- bind_rows(mr, prof, gwyn) |>
  relocate(wheel, dumpster, date, month, year)
```

```{r}
prof_total_weight_tons <- trash_all |>
  filter(wheel == "Professor Trash Wheel") |>
  summarise(total_weight_tons = sum(weight, na.rm = TRUE))

gwyn_june2022_cigs <- trash_all |>
  filter(wheel == "Gwynnda Trash Wheel", year == 2022, month == "June") |>
  summarise(total_cigs = sum(cigarette, na.rm = TRUE))

prof_total_weight_tons
gwyn_june2022_cigs

```
After cleaning and merging the datasets, we ended up with a tidy data frame containing `r nrow(trash_all)` observations and `r ncol(trash_all)` variables. The dataset records information from different Trash Wheels and includes variables such as collection date, dumpster number, total weight of trash (in tons), and counts of items like plastic bottles, polystyrene, cigarette butts, glass bottles, plastic bags, wrappers, and sports balls. For example, the variable *weight* measures how many tons of trash were collected for each dumpster, while *cigarette* and *sports_balls* keep track of more specific items. Altogether, Professor Trash Wheel collected `r prof_total_weight_tons$total_weight_tons` tons of trash. Looking at a single case, Gwynnda removed `r gwyn_june2022_cigs$total_cigs` cigarette butts in June 2022. These results give us a concrete picture of how much waste is entering the harbor and also highlight the important role each Trash Wheel plays in improving the local environment.  


# Problem 3

```{r}
library(readr)
library(dplyr)
library(janitor)
library(tidyr)

zip_file  <- "data/zillow_data/Zip Codes.csv"
zori_file <- "data/zillow_data/Zip_zori_uc_sfrcondomfr_sm_month_NYC.csv"

zip_raw  <- read_csv(zip_file,  show_col_types = FALSE) |> clean_names()
zori_raw <- read_csv(zori_file, show_col_types = FALSE) |> clean_names()


```

```{r}
glimpse(zip_raw)
glimpse(zori_raw)
```

```{r}
# ZIP–neighborhoods
zip_codes <- zip_raw |>
  transmute(
    zip = sprintf("%05d", as.integer(zip_code)),
    county = county,
    borough = case_match(
      county,
      "New York" ~ "Manhattan",
      "Kings"    ~ "Brooklyn",
      "Queens"   ~ "Queens",
      "Bronx"    ~ "Bronx",
      "Richmond" ~ "Staten Island",
      .default   = county
    ),
    neighborhood
  )

```

```{r}
# Zillow ZORI wide -> long
zori_tidy <- zori_raw |>
  rename(zip = region_name) |>
  mutate(zip = sprintf("%05d", as.integer(zip))) |>
  pivot_longer(
    cols = starts_with("x20"),
    names_to  = "date_str",
    values_to = "rent"
  ) |>
  mutate(
    month = as.Date(sub("^x", "", date_str), format = "%Y_%m_%d"),
    month = as.Date(format(month, "%Y-%m-01"))
  ) |>
  select(zip, county_name, month, rent) |>
  arrange(zip, month)
```

```{r}
rent_merged <- zori_tidy |>
  left_join(zip_codes, by = "zip") |>
  relocate(zip, borough, neighborhood, county_name, month, rent)

n_obs_total <- nrow(rent_merged)
n_zip       <- n_distinct(rent_merged$zip)
n_hood      <- n_distinct(rent_merged$neighborhood, na.rm = TRUE)

zips_in_zip_only <- setdiff(zip_codes$zip, unique(zori_tidy$zip))
zips_only_df <- tibble(zip = sort(zips_in_zip_only)) |>
  left_join(select(zip_codes, zip, borough, neighborhood), by = "zip")

jan2020 <- rent_merged |>
  filter(month == as.Date("2020-01-01")) |>
  select(zip, rent_2020 = rent)

jan2021 <- rent_merged |>
  filter(month == as.Date("2021-01-01")) |>
  select(zip, rent_2021 = rent)

drop_tbl <- rent_merged |>
  distinct(zip, borough, neighborhood) |>
  left_join(jan2020, by = "zip") |>
  left_join(jan2021, by = "zip") |>
  mutate(diff_2021_vs_2020 = rent_2021 - rent_2020) |>
  arrange(diff_2021_vs_2020) |>
  slice_head(n = 10)

```

```{r}
zips_in_zip_only <- setdiff(zip_codes$zip, unique(zori_tidy$zip))

zips_only_df <- tibble(
  zip = sort(zips_in_zip_only)
) |>
  left_join(select(zip_codes, zip, borough, neighborhood), by = "zip")
jan2020 <- rent_merged |>
  filter(month == as.Date("2020-01-01")) |>
  select(zip, rent_2020 = rent)

jan2021 <- rent_merged |>
  filter(month == as.Date("2021-01-01")) |>
  select(zip, rent_2021 = rent)

drop_tbl <- rent_merged |>
  distinct(zip, borough, neighborhood) |>
  left_join(jan2020, by = "zip") |>
  left_join(jan2021, by = "zip") |>
  mutate(diff_2021_vs_2020 = rent_2021 - rent_2020) |>
  arrange(diff_2021_vs_2020) |>
  slice_head(n = 10)
```

```{r}
n_obs_total; n_zip; n_hood
zips_only_df
drop_tbl
```

After cleaning and merging the two datasets, the final tidy dataset contains `r n_obs_total` observations. In total, there are `r n_zip` unique ZIP codes and `r n_hood` distinct neighborhoods represented across New York City. Some ZIP codes present in the ZIP code reference file are not included in the Zillow rental dataset; for example, `r paste(head(zips_in_zip_only, 3), collapse = ", ")`. These omissions may be due to low population density, limited rental market activity, or a lack of sufficient listings in those areas.

When comparing rental prices during the pandemic, we observe substantial declines. In particular, between January 2020 and January 2021, the ten ZIP codes with the steepest drops in rent are shown in Table X. Many of these are in Manhattan, reflecting broader out-migration and depressed rental demand during the peak of COVID-19 restrictions.

